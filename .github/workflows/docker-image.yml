name: Build, Package JAR, and Push Docker Image to ECR

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CONTAINER_REGISTRY: 767397794709.dkr.ecr.us-east-2.amazonaws.com/lanceplarsen
  NAME: payments
  VERSION: v0.0.16
  WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
  WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}
  WIZ_VULN_POLICY: "Default vulnerabilities policy"
  WIZ_SENSITIVE_DATA_POLICY: "Default sensitive data policy"
  WIZ_SECRETS_POLICY: "Default secrets policy"
  WIZ_IAC_POLICY: "Default IaC policy"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 12
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '12'

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build with Gradle
      run: ./gradlew clean build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image and tag with latest and semvar
      run: |
       docker build -t ${CONTAINER_REGISTRY}/${NAME}:latest -t ${CONTAINER_REGISTRY}/${NAME}:${VERSION} .

    - name: Download Wiz CLI
      run: curl -o wizcli https://wizcli.app.wiz.io/latest/wizcli && chmod +x wizcli

    - name: Authenticate to Wiz
      run: sudo -E ./wizcli auth --id "$WIZ_CLIENT_ID" --secret "$WIZ_CLIENT_SECRET"

    - name: Wiz CLI image scan
      id: scan
      run: |-
        sudo -E ./wizcli docker scan -i ${CONTAINER_REGISTRY}/${NAME}:${VERSION} --sensitive-data --secrets --policy "$WIZ_SECRETS_POLICY" --policy "$WIZ_VULN_POLICY" --policy "$WIZ_SENSITIVE_DATA_POLICY" --policy-hits-only \
        --driver mountWithLayers --dockerfile "./Dockerfile" --output wiz-output.json,sarif,true --tag github_action_run_id=${{ github.run_id }}
      continue-on-error: true

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2

    - name: Log in to Amazon ECR
      run: |
        aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 767397794709.dkr.ecr.us-east-2.amazonaws.com

    - name: Push Docker image to ECR (latest and semvar)
      run: |
        docker push ${CONTAINER_REGISTRY}/${NAME}:latest
        docker push ${CONTAINER_REGISTRY}/${NAME}:${VERSION}

    - name: Run Wiz CLI image tag
      run: sudo -E ./wizcli docker tag -i ${CONTAINER_REGISTRY}/${NAME}:${VERSION}